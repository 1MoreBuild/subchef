name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g. v0.1.0)"
        required: true
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      PACKAGE_NAME: subchef
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout selected tag
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          git fetch --tags --force
          git checkout "${{ inputs.tag }}"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.23.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.12.0
          cache: pnpm
          registry-url: https://registry.npmjs.org

      - name: Resolve release version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RELEASE_TAG="${{ inputs.tag }}"
          else
            RELEASE_TAG="${GITHUB_REF_NAME}"
          fi

          if ! echo "${RELEASE_TAG}" | grep -Eq '^v[0-9]+\.[0-9]+\.[0-9]+([.-][0-9A-Za-z.-]+)?$'; then
            echo "Invalid tag format: ${RELEASE_TAG}"
            exit 1
          fi

          RELEASE_VERSION="${RELEASE_TAG#v}"
          PACKAGE_VERSION="$(node -e "const fs=require('node:fs');const p=JSON.parse(fs.readFileSync('package.json','utf8'));process.stdout.write(p.version)")"

          if [ "${PACKAGE_VERSION}" != "${RELEASE_VERSION}" ]; then
            echo "Tag version (${RELEASE_VERSION}) does not match package.json (${PACKAGE_VERSION})"
            exit 1
          fi

          echo "RELEASE_TAG=${RELEASE_TAG}" >> "${GITHUB_ENV}"
          echo "RELEASE_VERSION=${RELEASE_VERSION}" >> "${GITHUB_ENV}"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run quality checks
        run: |
          pnpm check
          pnpm build

      - name: Publish npm package (OIDC trusted publishing)
        run: |
          if npm view "${PACKAGE_NAME}@${RELEASE_VERSION}" version >/dev/null 2>&1; then
            echo "${PACKAGE_NAME}@${RELEASE_VERSION} already published, skip npm publish."
          else
            # Ensure npm does not use token-based auth so trusted publishing can use OIDC.
            npm config delete //registry.npmjs.org/:_authToken || true
            npm publish --provenance --access public
          fi
        env:
          NODE_AUTH_TOKEN: ""
